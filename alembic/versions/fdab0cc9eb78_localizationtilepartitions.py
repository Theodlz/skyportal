"""localizatintilepartitions

Revision ID: fdab0cc9eb78
Revises: 47a76ff0f3ce
Create Date: 2023-04-19 09:08:38.281780

"""
from alembic import op
import sqlalchemy as sa
import healpix_alchemy

# revision identifiers, used by Alembic.
revision = 'fdab0cc9eb78'
down_revision = '47a76ff0f3ce'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        'localizationtiles',
        sa.Column(
            'dateobs',
            sa.Date(),
            nullable=False,
            server_default=sa.text("'2023-01-01'::date"),
        ),
    )
    # op.create_index(
    #     'localizationtile_id_healpix_dateobs_index',
    #     'localizationtiles',
    #     ['id', 'healpix', 'dateobs'],
    #     unique=False,
    # )
    # add the dateobs to the primary key
    op.execute('ALTER TABLE localizationtiles DROP CONSTRAINT localizationtiles_pkey')
    # rename localizationtiles to localizationtiles_def
    op.execute('ALTER TABLE localizationtiles RENAME TO localizationtiles_def')

    # rename also the indexes
    op.execute(
        'ALTER INDEX ix_localizationtiles_created_at RENAME TO localizationtiles_def_created_at_idx'
    )
    op.execute(
        'ALTER INDEX ix_localizationtiles_probdensity RENAME TO localizationtiles_def_probdensity_idx'
    )
    op.execute(
        'ALTER INDEX ix_localizationtiles_healpix RENAME TO localizationtiles_def_healpix_idx'
    )
    op.execute(
        'ALTER INDEX ix_localizationtiles_localization_id RENAME TO localizationtiles_def_localization_id_idx'
    )
    # drop it now
    op.execute('DROP INDEX localizationtile_id_healpix_index')
    op.create_index(
        'localizationtile_def_id_healpix_dateobs_index',
        'localizationtiles_def',
        ['id', 'healpix', 'dateobs'],
        unique=False,
    )
    # edit the foreign key constraint
    op.execute(
        'ALTER TABLE localizationtiles_def DROP CONSTRAINT localizationtiles_localization_id_fkey'
    )
    op.execute(
        'ALTER TABLE localizationtiles_def ADD CONSTRAINT localizationtiles_def_localization_id_fkey FOREIGN KEY (localization_id) REFERENCES localizations (id) ON DELETE CASCADE'
    )
    op.execute(
        'ALTER TABLE localizationtiles_def ADD PRIMARY KEY (id, localization_id, healpix, dateobs)'
    )

    # create localizationtiles partition table
    # op.execute(
    #     'CREATE SEQUENCE localizationtiles_id_seq START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1'
    # )
    op.execute(
        '''CREATE TABLE localizationtiles (
            id INTEGER NOT NULL DEFAULT nextval('localizationtiles_id_seq'::regclass),
            created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL,
            modified TIMESTAMP WITHOUT TIME ZONE NOT NULL,
            localization_id INTEGER NOT NULL,
            probdensity FLOAT NOT NULL,
            dateobs DATE NOT NULL DEFAULT '2023-01-01'::DATE
            ) PARTITION BY RANGE (dateobs)
            '''
    )

    # add the healpix column to the partition table
    op.add_column(
        'localizationtiles',
        sa.Column('healpix', healpix_alchemy.types.Tile(), nullable=False),
    )

    # add foreign key constraint on localization_id
    op.execute(
        'ALTER TABLE localizationtiles ADD CONSTRAINT localizationtiles_localization_id_fkey FOREIGN KEY (localization_id) REFERENCES localizations (id) ON DELETE CASCADE'
    )

    # add index on created_at
    op.create_index(
        'localizationtiles_created_at_idx',
        'localizationtiles',
        ['created_at'],
        unique=False,
    )
    # add index on probdensity
    op.create_index(
        'localizationtiles_probdensity_idx',
        'localizationtiles',
        ['probdensity'],
        unique=False,
    )
    # add index on localization_id
    op.create_index(
        'localizationtiles_localization_id_idx',
        'localizationtiles',
        ['localization_id'],
        unique=False,
    )
    # add index on healpix
    op.create_index(
        'localizationtiles_healpix_idx',
        'localizationtiles',
        ['healpix'],
        unique=False,
        postgresql_using='spgist',
    )
    # add an index on both id and healpix
    op.create_index(
        'localizationtile_id_healpix_dateobs_index',
        'localizationtiles',
        ['id', 'healpix', 'dateobs'],
        unique=True,
    )

    # primary key on id, localization_id, healpix
    op.execute(
        'ALTER TABLE localizationtiles ADD PRIMARY KEY (id, localization_id, healpix, dateobs)'
    )

    # attach the default partition (default range, when outside of all other ranges)
    op.execute(
        "ALTER TABLE localizationtiles ATTACH PARTITION localizationtiles_def DEFAULT"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_04 PARTITION OF localizationtiles FOR VALUES FROM ('2023-04-01') TO ('2023-05-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_05 PARTITION OF localizationtiles FOR VALUES FROM ('2023-05-01') TO ('2023-06-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_06 PARTITION OF localizationtiles FOR VALUES FROM ('2023-06-01') TO ('2023-07-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_07 PARTITION OF localizationtiles FOR VALUES FROM ('2023-07-01') TO ('2023-08-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_08 PARTITION OF localizationtiles FOR VALUES FROM ('2023-08-01') TO ('2023-09-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_09 PARTITION OF localizationtiles FOR VALUES FROM ('2023-09-01') TO ('2023-10-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_10 PARTITION OF localizationtiles FOR VALUES FROM ('2023-10-01') TO ('2023-11-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_11 PARTITION OF localizationtiles FOR VALUES FROM ('2023-11-01') TO ('2023-12-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2023_12 PARTITION OF localizationtiles FOR VALUES FROM ('2023-12-01') TO ('2024-01-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_01 PARTITION OF localizationtiles FOR VALUES FROM ('2024-01-01') TO ('2024-02-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_02 PARTITION OF localizationtiles FOR VALUES FROM ('2024-02-01') TO ('2024-03-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_03 PARTITION OF localizationtiles FOR VALUES FROM ('2024-03-01') TO ('2024-04-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_04 PARTITION OF localizationtiles FOR VALUES FROM ('2024-04-01') TO ('2024-05-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_05 PARTITION OF localizationtiles FOR VALUES FROM ('2024-05-01') TO ('2024-06-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_06 PARTITION OF localizationtiles FOR VALUES FROM ('2024-06-01') TO ('2024-07-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_07 PARTITION OF localizationtiles FOR VALUES FROM ('2024-07-01') TO ('2024-08-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_08 PARTITION OF localizationtiles FOR VALUES FROM ('2024-08-01') TO ('2024-09-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_09 PARTITION OF localizationtiles FOR VALUES FROM ('2024-09-01') TO ('2024-10-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_10 PARTITION OF localizationtiles FOR VALUES FROM ('2024-10-01') TO ('2024-11-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_11 PARTITION OF localizationtiles FOR VALUES FROM ('2024-11-01') TO ('2024-12-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2024_12 PARTITION OF localizationtiles FOR VALUES FROM ('2024-12-01') TO ('2025-01-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2025_01 PARTITION OF localizationtiles FOR VALUES FROM ('2025-01-01') TO ('2025-02-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2025_02 PARTITION OF localizationtiles FOR VALUES FROM ('2025-02-01') TO ('2025-03-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2025_03 PARTITION OF localizationtiles FOR VALUES FROM ('2025-03-01') TO ('2025-04-01')"
    )
    op.execute(
        "CREATE TABLE localizationtiles_2025_04 PARTITION OF localizationtiles FOR VALUES FROM ('2025-04-01') TO ('2025-05-01')"
    )
